


\newcommand{\ida}[1]{\protidname{A}{#1}}
\newcommand{\idb}[1]{\protidname{B}{#1}}
\newcommand{\tset}[2]{\begin{array}{c}\{ #1 \} \\[2mm] \{ #2 \}\end{array}}

\tikzset{
  rulelabel/.style={circle,draw=black,fill=red!20,inner sep=1pt}
}

\begin{tikzpicture}[
  auto,
]

\matrix (m) [matrix of math nodes, column sep={25mm, between origins}, row sep=10mm, anchor=south west] at (0, 0) {
  \{ \idb{2} \} & \phantom{a} & \{ \idb{4} \} & \{ \idb{4} \} & \{ \idb{4} \} & \{ \idb{5} \} & \phantom{a} \\
   & & \tset{\ida{2}}{\idb{2}} &  \\
  \phantom{a} 
  & \tset{\ida{1}, \ida{2}}{\idb{1}, \idb{2}}
  & \tset{\ida{1}, \ida{3}}{\idb{1}, \idb{3}}
  & \tset{\ida{1}, \ida{3}}{\idb{1}, \idb{5}}
  & \phantom{a}
  & \tset{\ida{1}}{\idb{1}, \idb{5}}
  & \tset{\ida{1}, \ida{4}}{\idb{1}, \idb{5}, \idb{6}} \\
};

% Draw outer grid
\draw[->] (m.south west) -- (m.north west) node[midway, rotate=270, below] {position ($\pos$)};
\draw[->] (m.south west) -- (m.south east) node[midway, below] {time ($t$)};


% \fill[red] (m-1-1.center) circle (2pt);
% \fill[blue] (m-1-2.center) circle (2pt);

% Draw faint grid lines (bit of a hack, but hey, it works, sort of)
\foreach \X [count=\n] in {2,3,4,5,6,7} {
  \draw[gray,dashed] ($(m-1-\n.north)!0.5!(m-1-\X.north)$) -- ($(m-3-\n.south)!0.5!(m-3-\X.south)$);
  % \draw ($(m-\n-1.west)!0.5!(m-\X-1.west)$) -- ($(m-\n-7.east)!0.5!(m-\X-7.east)$);
}

% Rule 1
\node[fit=(m-1-5)(m-1-6), draw] (rule1) {};
\node[rulelabel] at (rule1.north east) {1};

% Rule 2
\node[fit=(m-2-3), draw](rule2) {};
\node[rulelabel] at (rule2.north east) {2};

% Rule 3
\node[fit=(m-3-3)(m-3-4), draw, inner sep=1pt] (rule3) {};
\node[rulelabel] at (rule3.north east) {3};


% Rule 4
\node[fit=(m-3-2)(m-3-3), draw, red, inner sep = -2pt] (rule4) {};
\node[rulelabel] at (rule4.north east) {4};

% Rule 5
\node[fit=(m-3-6)(m-3-7), draw, inner sep=-1pt] (rule5) {};
\node[rulelabel] at (rule5.north east) {5};

% Block 6, rule 2 (after elimination)
\node[fit=(m-3-3), draw, inner xsep=-8pt, inner ysep=6pt, yshift=-3pt, blue] (block6) {};
\node[rulelabel] at (block6.south east) {6};

% \draw [brown] (current bounding box.south west) rectangle (current bounding box.north east);
\end{tikzpicture}